<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>认证方式 | 前端自学指南</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/frontend-summary/img/headLogo.jpg">
    <meta name="description" content="前端学习的心路历程">
    <link rel="preload" href="/frontend-summary/assets/css/0.styles.8996fafd.css" as="style"><link rel="preload" href="/frontend-summary/assets/js/app.d040e4f2.js" as="script"><link rel="preload" href="/frontend-summary/assets/js/3.332dd64b.js" as="script"><link rel="preload" href="/frontend-summary/assets/js/41.755a79c8.js" as="script"><link rel="prefetch" href="/frontend-summary/assets/js/10.cb36361a.js"><link rel="prefetch" href="/frontend-summary/assets/js/11.c6772edc.js"><link rel="prefetch" href="/frontend-summary/assets/js/12.d672fa33.js"><link rel="prefetch" href="/frontend-summary/assets/js/13.2e52daed.js"><link rel="prefetch" href="/frontend-summary/assets/js/14.b0429b8f.js"><link rel="prefetch" href="/frontend-summary/assets/js/15.0b323b6d.js"><link rel="prefetch" href="/frontend-summary/assets/js/16.81fea3b7.js"><link rel="prefetch" href="/frontend-summary/assets/js/17.4f66820a.js"><link rel="prefetch" href="/frontend-summary/assets/js/18.cf9a34d7.js"><link rel="prefetch" href="/frontend-summary/assets/js/19.f2f5cc9b.js"><link rel="prefetch" href="/frontend-summary/assets/js/20.ca795f44.js"><link rel="prefetch" href="/frontend-summary/assets/js/21.816f386f.js"><link rel="prefetch" href="/frontend-summary/assets/js/22.c59687c6.js"><link rel="prefetch" href="/frontend-summary/assets/js/23.1d3a198a.js"><link rel="prefetch" href="/frontend-summary/assets/js/24.65c4a1ec.js"><link rel="prefetch" href="/frontend-summary/assets/js/25.4741ea33.js"><link rel="prefetch" href="/frontend-summary/assets/js/26.494d2462.js"><link rel="prefetch" href="/frontend-summary/assets/js/27.aaa76c5e.js"><link rel="prefetch" href="/frontend-summary/assets/js/28.1d850131.js"><link rel="prefetch" href="/frontend-summary/assets/js/29.cc6b2a24.js"><link rel="prefetch" href="/frontend-summary/assets/js/30.93deee72.js"><link rel="prefetch" href="/frontend-summary/assets/js/31.3df02ac8.js"><link rel="prefetch" href="/frontend-summary/assets/js/32.716d852e.js"><link rel="prefetch" href="/frontend-summary/assets/js/33.608080c4.js"><link rel="prefetch" href="/frontend-summary/assets/js/34.b5d27930.js"><link rel="prefetch" href="/frontend-summary/assets/js/35.c6effab0.js"><link rel="prefetch" href="/frontend-summary/assets/js/36.fe90ce38.js"><link rel="prefetch" href="/frontend-summary/assets/js/37.95fc5385.js"><link rel="prefetch" href="/frontend-summary/assets/js/38.c5b50629.js"><link rel="prefetch" href="/frontend-summary/assets/js/39.b1d1e2b9.js"><link rel="prefetch" href="/frontend-summary/assets/js/4.2d5d675c.js"><link rel="prefetch" href="/frontend-summary/assets/js/40.7aef4e78.js"><link rel="prefetch" href="/frontend-summary/assets/js/42.76b41c8a.js"><link rel="prefetch" href="/frontend-summary/assets/js/5.f053a152.js"><link rel="prefetch" href="/frontend-summary/assets/js/6.bbc48170.js"><link rel="prefetch" href="/frontend-summary/assets/js/7.18824614.js"><link rel="prefetch" href="/frontend-summary/assets/js/8.4516358a.js"><link rel="prefetch" href="/frontend-summary/assets/js/9.2cd21853.js"><link rel="prefetch" href="/frontend-summary/assets/js/vendors~docsearch.f5584d80.js">
    <link rel="stylesheet" href="/frontend-summary/assets/css/0.styles.8996fafd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/frontend-summary/zh/" class="home-link router-link-active"><img src="/frontend-summary/img/searchLogo.jpg" alt="前端自学指南" class="logo"> <span class="site-name can-hide">前端自学指南</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/frontend-summary/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/frontend-summary/zh/basics/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶指南 Menu" class="dropdown-title"><span class="title">进阶指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/nestjs/introduction.html" class="nav-link">
  Nestjs
</a></li><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/ci/" class="nav-link">
  Ci
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/tilkofjin" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend-summary/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/frontend-summary/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/frontend-summary/zh/basics/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶指南 Menu" class="dropdown-title"><span class="title">进阶指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/nestjs/introduction.html" class="nav-link">
  Nestjs
</a></li><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/ci/" class="nav-link">
  Ci
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/tilkofjin" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend-summary/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Nestjs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend-summary/zh/guide/nestjs/introduction.html" class="sidebar-link">介绍</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>概览</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>基本原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>技术</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html" aria-current="page" class="active sidebar-link">认证方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html#认证方式介绍" class="sidebar-link">认证方式介绍</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html#认证要求" class="sidebar-link">认证要求</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html#实施-passport-策略" class="sidebar-link">实施 Passport 策略</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html#在本地实施-passport" class="sidebar-link">在本地实施 Passport</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html#内置-passport-守卫" class="sidebar-link">内置 passport 守卫</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html#登陆路由" class="sidebar-link">登陆路由</a></li></ul></li></ul></section></li></ul></section></li><li><a href="/frontend-summary/zh/guide/ci.html" class="sidebar-link">CI</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="认证方式介绍"><a href="#认证方式介绍" class="header-anchor">#</a> 认证方式介绍</h2> <p>身份验证是大多数应用程序中必不可少的部分。有很多不同的方法和策略来处理身份验证。任何项目采用的方法取决于其特定的应用程序要求。本章介绍了几种可以适应各种不同要求的身份验证方法：</p> <p><a href="https://github.com/jaredhanson/passport" target="_blank" rel="noopener noreferrer"><font color="red">Passport</font><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是最受欢迎的 <code>node.js</code> 身份验证库，在社区中广为人知并成功用于许多生产应用中。使用 <code>@nestjs/passport</code> 模块将该库与 <code>Nest</code> 应用程序集成起来很简单。在较高级别，<code>Passport</code> 执行一系列步骤以：</p> <ul><li>通过验证用户的 &quot;凭据&quot; (例如用户名/密码，JSON Web token(JWT) 或来自身份提供者的身份令牌)</li> <li>管理身份验证状态(通过发出可移植的 token (例如JWT) 或创建 <a href="https://github.com/expressjs/session" target="_blank" rel="noopener noreferrer"><font color="red">Express 会话</font><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</li> <li>将有关经过身份验证的用户的信息附加到 <code>Request</code> 对象，以在路由处理程序中进一步使用</li></ul> <p><code>Passport</code> 具有丰富的策略生态系统，可实施各种身份验证机制。虽然概念上很简单，但是您可以选择的 <code>Passport</code> 策略集很大，并且存在很多变化。<code>Passport</code> 将这些不同的步骤抽象为标准模式，<code>@nestjs/passport</code> 模块将该模式包装并标准化为熟悉的 <code>Nest</code> 结构。</p> <p>在本章中，我们将使用这些强大而灵活的模块为 <code>RESTful API</code> 服务器实现完整的端到端身份验证解决方案。您可以使用此处描述的概念来实施任何 <code>Passport</code> 策略以自定义身份验证方案。您可以按照本章中的步骤构建完整的示例。您可以在<a href="https://github.com/nestjs/nest/tree/master/sample/19-auth-jwt" target="_blank" rel="noopener noreferrer">此处<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>找到带有完整示例应用程序的存储库。</p> <h2 id="认证要求"><a href="#认证要求" class="header-anchor">#</a> 认证要求</h2> <p>让我们充实我们的要求。 对于此用例，客户端将从使用用户名和密码进行身份验证开始。一旦通过身份验证，服务器将发出一个 <code>JWT</code>，该 <code>JWT</code> 可以作为<a href="https://tools.ietf.org/html/rfc6750" target="_blank" rel="noopener noreferrer">承载令牌在后续请求中的授权标头<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中发送以证明身份验证。我们还将创建一个受保护的路由，只有包含有效 <code>JWT</code> 的请求才能访问该路由。</p> <p>我们将从第一个要求开始：对用户进行身份验证。然后，我们将通过发布 <code>JWT</code> 来扩展它。最后，我们将创建一个受保护的路由，以检查请求上的有效 <code>JWT</code> 。</p> <p>首先，我们需要安装所需的软件包。<code>Passport</code> 提供了称为<a href="https://github.com/jaredhanson/passport-local" target="_blank" rel="noopener noreferrer">passport-local<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的策略，该策略实现了用户名/密码身份验证机制，符合我们对用例这一部分的需求。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/passport passport passport-local
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev @types/passport-local
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>对于您选择的任何 <code>Passport</code> 策略，您将始终需要 <code>@nestjs/passport</code> 和护照包。然后，您需要安装特定于策略的软件包(例如，<code>passport-jwt</code> 或 <code>passport-local</code>)，以实现您要构建的特定身份验证策略。此外，您还可以为任何 <code>Passport</code> 策略安装类型定义，如上面的 <code>@types/passport-local</code> 所示，它在编写 <code>TypeScript</code> 代码时提供了帮助。</p></div> <h2 id="实施-passport-策略"><a href="#实施-passport-策略" class="header-anchor">#</a> 实施 <code>Passport</code> 策略</h2> <p>现在，我们准备实现身份验证功能。我们将首先概述用于任何 <code>Passport</code> 策略的过程。可以将 <code>Passport</code> 本身视为一个小型框架。该框架的优雅之处在于，它将身份验证过程抽象为您根据要实施的策略自定义的几个基本步骤。您可以通过以回调函数的形式提供自定义参数(作为纯 <code>JSON</code> 对象)和自定义代码来进行配置。<code>@nestjs/ passport</code> 模块将此框架包装在 <code>Nest</code> 样式包中，从而易于集成到 <code>Nest</code> 应用程序中。我们将在下面使用 <code>@nestjs/passport</code>，但首先让我们考虑一下 <code>Vanilla Passport</code> 的工作原理。</p> <p>在 <code>Vanilla Passport</code> 中，您通过提供以下两点来配置策略：
1、特定于该策略的一组选项。例如，在 <code>JWT</code> 策略中，您可以提供一个秘密来对令牌进行签名。
2、&quot;验证回调&quot;，您可以在其中告诉 <code>Passport</code> 如何与用户商店进行交互(您可以在其中管理用户帐户)。在这里，您验证用户是否存在（或创建一个新用户），以及他们的凭据是否有效。如果验证成功，<code>Passport</code> 库希望此回调返回完整的用户，如果失败，则返回 <code>null</code>(失败定义为找不到用户，或者，如果是 <code>passport-local</code>，则密码不匹配)。</p> <p>使用 <code>@nestjs/passport</code>，可以通过扩展 <code>PassportStrategy</code> 类来配置 <code>Passport</code> 策略。通过在子类中调用 <code>super()</code> 方法来传递策略选项(上面的项目1)，可以选择传入一个选项对象。您可以通过在子类中实现 <code>validate()</code> 方法来提供 <code>verify</code> 回调(上面的项目2)。</p> <p>我们将从生成一个 <code>AuthModule</code> 以及其中的 <code>AuthService</code> 开始：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest g module auth
$ nest g <span class="token function">service</span> auth
</code></pre></div><p>在实现 <code>AuthService</code> 时，我们发现将用户操作封装在 <code>UsersService</code> 中很有用，因此，让我们现在生成该模块和服务：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nest g module <span class="token function">users</span>
$ nest g <span class="token function">service</span> <span class="token function">users</span>
</code></pre></div><p>替换这些生成文件的默认内容，如下所示。对于我们的示例应用程序，<code>UsersService</code> 只需维护一个硬编码的内存用户列表，以及一个通过用户名检索的查找方法。在真实的应用中，您可以使用选择的库(例如 <code>TypeORM，Sequelize，Mongoose</code> 等)在此处构建用户模型和持久层。</p> <div class="custom-block tip"><p class="custom-block-title">官方示例</p> <div class="language- extra-class"><pre><code>users/users.service.js
</code></pre></div></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>users <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'john'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'changeme'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'chris'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'secret'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'maria'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'guess'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token parameter">username</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>username <span class="token operator">===</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>UsersModule</code> 中，唯一需要做的更改是将 <code>UsersService</code> 添加到 <code>@Module</code> 装饰器的 <code>exports</code> 数组中，以便在此模块外部可见(我们将在 <code>AuthService</code> 中很快使用它)。</p> <div class="custom-block tip"><p class="custom-block-title">官方示例</p> <div class="language- extra-class"><pre><code>users/users.module.ts
</code></pre></div></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>UsersService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>UsersService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UsersModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>我们的 <code>AuthService</code> 负责检索用户并验证密码。为此，我们创建一个 <code>validateUser()</code> 方法。在下面的代码中我们使用方便的 <code>ES6</code> 扩张操作符(...)在返回用户对象之前从用户对象中删除 <code>password</code> 属性。稍后，我们将从 <code>Passport</code> 本地策略中调用 <code>validateUser()</code> 方法。</p> <div class="custom-block tip"><p class="custom-block-title">官方示例</p> <div class="language- extra-class"><pre><code>auth/auth.service.ts
</code></pre></div></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> usersService<span class="token operator">:</span> UsersService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> pass<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>usersService<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span>password <span class="token operator">===</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> password<span class="token punctuation">,</span> <span class="token operator">...</span>result <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>当然，在实际的应用程序中，您不会以纯文本形式存储密码。取而代之的是使用带有单向哈希算法的 <a href="https://github.com/kelektiv/node.bcrypt.js#readme" target="_blank" rel="noopener noreferrer"><font color="red">bcrypt</font><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>之类的库。采用这种方法，您只需存储哈希密码，然后将存储的密码与输入密码的哈希版本进行比较，因此，切勿以纯文本格式存储或公开用户密码。为了使我们的示例应用程序简单，我们违反了该绝对授权，并使用纯文本。<font color="red">不要在您的真实应用中这样做！</font></p></div> <p>现在，我们更新 <code>AuthModule</code> 以导入 <code>UsersModule</code>。</p> <div class="custom-block tip"><p class="custom-block-title">官方示例</p> <div class="language- extra-class"><pre><code>auth/auth.module.ts
</code></pre></div></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>UsersModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="在本地实施-passport"><a href="#在本地实施-passport" class="header-anchor">#</a> 在本地实施 <code>Passport</code></h2> <p>现在我们可以实施我们的 <code>Passport</code> 本地身份验证策略，在 <code>auth</code> 文件夹中创建一个名为 <code>local.strategy.ts</code> 的文件，并添加以下代码：</p> <div class="custom-block tip"><p class="custom-block-title">官方示例</p> <div class="language- extra-class"><pre><code>auth/local.strategy.ts
</code></pre></div></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Strategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'passport-local'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> UnauthorizedException <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LocalStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">PassportStrategy</span><span class="token punctuation">(</span>Strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> authService<span class="token operator">:</span> AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validate</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">validateUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnauthorizedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于所有 <code>Passport</code> 策略，我们都遵循了前面介绍的方法。在我们的本地护照使用案例中，没有配置选项，因此我们的构造函数只调用 <code>super()</code>，而没有选项对象。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>我们可以在对 <code>super()</code> 的调用中传递一个 <code>options</code> 对象，以自定义护照策略的行为。在此示例中，默认情况下，本地护照策略在请求正文中期望使用名为用户名和密码的属性。传递一个选项对象以指定不同的属性名称。例如：<code>super({{usernameField：'email'})</code>。有关更多信息，请参见 <code>Passport</code> 文档。</p></div> <p>我们还实现了 <code>validate()</code> 方法。对于每种策略，<code>Passport</code> 将使用适当的策略特定的参数集调用 <code>verify</code> 函数(通过 <code>@nestjs/passport</code> 中的 <code>validate()</code> 方法实现)。对于本地策略，<code>Passport</code> 希望使用带有以下签名的 <code>validate()</code> 方法：<code>validate(username: string, password:string): any</code>。</p> <p>大多数验证工作是在我们的 <code>AuthService</code> 中完成的(借助于 <code>UsersService</code> 的帮助)，因此此方法非常简单。任何 <code>Passport</code> 策略的 <code>validate()</code> 方法将遵循类似的模式，仅在表示凭据的方式细节方面有所不同。如果找到用户并且凭据有效，返回用户，以便 <code>Passport</code> 可以完成其任务(例如，在 <code>Request</code> 对象上创建 <code>user</code>属性)，并且请求处理管道可以继续。如果找不到，我们将抛出一个异常并让我们的<a href="https://docs.nestjs.com/exception-filters" target="_blank" rel="noopener noreferrer">异常层<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>处理它。</p> <p>通常，每种策略的 <code>validate()</code> 方法的唯一重要区别是您如何确定用户是否存在并有效。例如，在 <code>JWT</code> 策略中，根据要求，我们可能会评估解码令牌中携带的 <code>userId</code> 是否与我们的用户数据库中的记录匹配，或匹配已撤销令牌的列表。因此，这种子分类和实施策略特定验证的模式是一致，优雅且可扩展的。</p> <p>我们需要配置 <code>AuthModule</code> 以使用我们刚刚定义的 <code>Passport</code> 功能。更新 <code>auth.module.ts</code> 如下所示：</p> <div class="custom-block tip"><p class="custom-block-title">官方示例</p> <div class="language- extra-class"><pre><code>auth/auth.module.ts
</code></pre></div></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UsersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PassportModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/passport'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./local.strategy'</span><span class="token punctuation">;</span>

@<span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>UsersModule<span class="token punctuation">,</span> PassportModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">,</span> LocalStrategy<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="内置-passport-守卫"><a href="#内置-passport-守卫" class="header-anchor">#</a> 内置 <code>passport</code> 守卫</h2> <p><code>Guards</code> 一章介绍了 <code>Guards</code> 的主要功能：确定请求是否将由路由处理程序处理。事实仍然如此，我们将很快使用该标准功能。但是，在使用 <code>@nestjs/passport</code> 模块的情况下，我们还将介绍一些起初可能会引起混淆的细微新皱纹，所以现在让我们进行讨论。从身份验证的角度考虑，您的应用可以处于两种状态：
1、用户/客户端未登录(未认证)
2、用户/客户端已登录(已验证)</p> <p>在第一种情况下(用户未登录)，我们需要执行两个不同的功能：</p> <ul><li>限制未经身份验证的用户可以访问的路由(即拒绝访问受限制的路由)。通过将 <code>Guard</code> 放在受保护的路由上，我们将以其熟悉的能力使用 <code>Guards</code> 来处理此功能。如您所料，我们将检查此 <code>Guard</code> 中是否存在有效的 <code>JWT</code>，因此，一旦我们成功发布 <code>JWT</code>，我们将在稍后使用此 <code>Guard</code>。</li> <li>当先前未经身份验证的用户尝试登录时，初始化<strong>身份验证步骤</strong>。这是我们向有效用户发出 <code>JWT</code> 的步骤。考虑片刻，我们需要发送用户名/密码凭证才能启动身份验证，因此我们将设置 <code>POST /auth /login</code> 路由来处理该问题。这就提出了一个问题：我们究竟如何在那条路线中调用 <code>passport-local</code> 策略?</li></ul> <p>答案很简单：通过使用另一种略有不同的 <code>Guard</code> 类型。<code>@nestjs/passport</code> 模块为我们提供了一个内置的 <code>Guard</code> 来为我们执行此操作。该 <code>Guard</code> 调用 <code>Passport</code> 策略并启动上述步骤(检索凭据，运行验证功能，创建用户属性等)。</p> <p>上面列举的第二种情况(登录用户)仅依赖于我们已经讨论过的 <code>Guard</code> 的标准类型，以使登录用户能够访问受保护的路由。</p> <h2 id="登陆路由"><a href="#登陆路由" class="header-anchor">#</a> 登陆路由</h2></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/frontend-summary/zh/guide/nestjs/fundamentals/testing.html" class="prev">
        测试
      </a></span> <span class="next"><a href="/frontend-summary/zh/guide/ci.html">
        CI
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/frontend-summary/assets/js/app.d040e4f2.js" defer></script><script src="/frontend-summary/assets/js/3.332dd64b.js" defer></script><script src="/frontend-summary/assets/js/41.755a79c8.js" defer></script>
  </body>
</html>
