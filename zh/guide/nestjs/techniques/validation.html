<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>验证 | 前端自学指南</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/frontend-summary/img/headLogo.jpg">
    <meta name="description" content="前端学习的心路历程">
    <link rel="preload" href="/frontend-summary/assets/css/0.styles.8996fafd.css" as="style"><link rel="preload" href="/frontend-summary/assets/js/app.e4308c2b.js" as="script"><link rel="preload" href="/frontend-summary/assets/js/3.332dd64b.js" as="script"><link rel="preload" href="/frontend-summary/assets/js/49.9c730a4d.js" as="script"><link rel="prefetch" href="/frontend-summary/assets/js/10.cb36361a.js"><link rel="prefetch" href="/frontend-summary/assets/js/11.c6772edc.js"><link rel="prefetch" href="/frontend-summary/assets/js/12.d672fa33.js"><link rel="prefetch" href="/frontend-summary/assets/js/13.2e52daed.js"><link rel="prefetch" href="/frontend-summary/assets/js/14.b0429b8f.js"><link rel="prefetch" href="/frontend-summary/assets/js/15.0b323b6d.js"><link rel="prefetch" href="/frontend-summary/assets/js/16.81fea3b7.js"><link rel="prefetch" href="/frontend-summary/assets/js/17.4f66820a.js"><link rel="prefetch" href="/frontend-summary/assets/js/18.cf9a34d7.js"><link rel="prefetch" href="/frontend-summary/assets/js/19.f2f5cc9b.js"><link rel="prefetch" href="/frontend-summary/assets/js/20.ca795f44.js"><link rel="prefetch" href="/frontend-summary/assets/js/21.816f386f.js"><link rel="prefetch" href="/frontend-summary/assets/js/22.c59687c6.js"><link rel="prefetch" href="/frontend-summary/assets/js/23.1d3a198a.js"><link rel="prefetch" href="/frontend-summary/assets/js/24.65c4a1ec.js"><link rel="prefetch" href="/frontend-summary/assets/js/25.4741ea33.js"><link rel="prefetch" href="/frontend-summary/assets/js/26.4afd1642.js"><link rel="prefetch" href="/frontend-summary/assets/js/27.aaa76c5e.js"><link rel="prefetch" href="/frontend-summary/assets/js/28.1d850131.js"><link rel="prefetch" href="/frontend-summary/assets/js/29.cc6b2a24.js"><link rel="prefetch" href="/frontend-summary/assets/js/30.93deee72.js"><link rel="prefetch" href="/frontend-summary/assets/js/31.3df02ac8.js"><link rel="prefetch" href="/frontend-summary/assets/js/32.716d852e.js"><link rel="prefetch" href="/frontend-summary/assets/js/33.608080c4.js"><link rel="prefetch" href="/frontend-summary/assets/js/34.b5d27930.js"><link rel="prefetch" href="/frontend-summary/assets/js/35.c6effab0.js"><link rel="prefetch" href="/frontend-summary/assets/js/36.fe90ce38.js"><link rel="prefetch" href="/frontend-summary/assets/js/37.95fc5385.js"><link rel="prefetch" href="/frontend-summary/assets/js/38.c5b50629.js"><link rel="prefetch" href="/frontend-summary/assets/js/39.b1d1e2b9.js"><link rel="prefetch" href="/frontend-summary/assets/js/4.5fb0a9cf.js"><link rel="prefetch" href="/frontend-summary/assets/js/40.7aef4e78.js"><link rel="prefetch" href="/frontend-summary/assets/js/41.4d251bc3.js"><link rel="prefetch" href="/frontend-summary/assets/js/42.c0c8558e.js"><link rel="prefetch" href="/frontend-summary/assets/js/43.ea2e2fc1.js"><link rel="prefetch" href="/frontend-summary/assets/js/44.b64ba9ac.js"><link rel="prefetch" href="/frontend-summary/assets/js/45.a655013e.js"><link rel="prefetch" href="/frontend-summary/assets/js/46.8b10a77d.js"><link rel="prefetch" href="/frontend-summary/assets/js/47.518bb53a.js"><link rel="prefetch" href="/frontend-summary/assets/js/48.8bf1a7df.js"><link rel="prefetch" href="/frontend-summary/assets/js/5.f053a152.js"><link rel="prefetch" href="/frontend-summary/assets/js/50.02511742.js"><link rel="prefetch" href="/frontend-summary/assets/js/6.39826cdd.js"><link rel="prefetch" href="/frontend-summary/assets/js/7.abee8995.js"><link rel="prefetch" href="/frontend-summary/assets/js/8.4516358a.js"><link rel="prefetch" href="/frontend-summary/assets/js/9.2cd21853.js"><link rel="prefetch" href="/frontend-summary/assets/js/vendors~docsearch.f5584d80.js">
    <link rel="stylesheet" href="/frontend-summary/assets/css/0.styles.8996fafd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/frontend-summary/zh/" class="home-link router-link-active"><img src="/frontend-summary/img/searchLogo.jpg" alt="前端自学指南" class="logo"> <span class="site-name can-hide">前端自学指南</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/frontend-summary/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/frontend-summary/zh/basics/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶指南 Menu" class="dropdown-title"><span class="title">进阶指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/nestjs/introduction.html" class="nav-link">
  Nestjs
</a></li><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/ci/" class="nav-link">
  Ci
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/tilkofjin" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend-summary/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/frontend-summary/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/frontend-summary/zh/basics/" class="nav-link">
  前端基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶指南 Menu" class="dropdown-title"><span class="title">进阶指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/nestjs/introduction.html" class="nav-link">
  Nestjs
</a></li><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/ci/" class="nav-link">
  Ci
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/tilkofjin" target="_self" rel="" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend-summary/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Nestjs</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend-summary/zh/guide/nestjs/introduction.html" class="sidebar-link">介绍</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>概览</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>基本原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>技术</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend-summary/zh/guide/nestjs/techniques/authentication.html" class="sidebar-link">认证方式</a></li><li><a href="/frontend-summary/zh/guide/nestjs/techniques/database.html" class="sidebar-link">数据库</a></li><li><a href="/frontend-summary/zh/guide/nestjs/techniques/mongo.html" class="sidebar-link">Mongo</a></li><li><a href="/frontend-summary/zh/guide/nestjs/techniques/configuration.html" class="sidebar-link">配置</a></li><li><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html" aria-current="page" class="active sidebar-link">验证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#总览" class="sidebar-link">总览</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#使用内置的验证管道" class="sidebar-link">使用内置的验证管道</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#自动验证" class="sidebar-link">自动验证</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#禁用错误详情" class="sidebar-link">禁用错误详情</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#属性剥离" class="sidebar-link">属性剥离</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#转换加载对象" class="sidebar-link">转换加载对象</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#显式转换" class="sidebar-link">显式转换</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#解析和验证数组" class="sidebar-link">解析和验证数组</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#websocket-和微服务" class="sidebar-link">WebSocket 和微服务</a></li><li class="sidebar-sub-header"><a href="/frontend-summary/zh/guide/nestjs/techniques/validation.html#学习更多" class="sidebar-link">学习更多</a></li></ul></li><li><a href="/frontend-summary/zh/guide/nestjs/techniques/caching.html" class="sidebar-link">缓存</a></li><li><a href="/frontend-summary/zh/guide/nestjs/techniques/serialization.html" class="sidebar-link">序列化</a></li><li><a href="/frontend-summary/zh/guide/nestjs/techniques/taskScheduling.html" class="sidebar-link">任务调度</a></li><li><a href="/frontend-summary/zh/guide/nestjs/techniques/compression.html" class="sidebar-link">压缩</a></li></ul></section></li></ul></section></li><li><a href="/frontend-summary/zh/guide/ci.html" class="sidebar-link">CI</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>最佳实践是验证发送到 <code>Web</code> 应用程序中的任何数据的正确性。为了自动验证传入的请求，<code>Nest</code> 提供了一些开箱即用的管道：</p> <ul><li>ValidationPipe</li> <li>ParseIntPipe</li> <li>ParseBoolPipe</li> <li>ParseArrayPipe</li> <li>ParseUUIDPipe</li></ul> <p><code>ValidationPipe</code> 利用功能强大的 <a href="https://github.com/typestack/class-validator" target="_blank" rel="noopener noreferrer"><font color="red">class-validator</font><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 包及其声明性验证修饰符。<code>ValidationPipe</code> 提供了一种对所有传入的客户端有效负载强制执行验证规则的便捷方法，其中在每个模块的本地类 <code>/DTO</code> 声明中使用简单的注释声明特定的规则。</p> <h2 id="总览"><a href="#总览" class="header-anchor">#</a> 总览</h2> <p>在 &quot;<a href="https://docs.nestjs.com/pipes" target="_blank" rel="noopener noreferrer"><font color="red">管道</font><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>&quot; 一章中，我们经历了构建简单管道并将其绑定到控制器，方法或全局应用程序的过程，以演示该过程如何工作。请务必阅读该章以最好地理解本章的主题。在这里，我们将重点研究 <code>ValidationPipe</code> 在现实世界中的各种使用案例，并展示如何使用其一些高级自定义功能。</p> <h2 id="使用内置的验证管道"><a href="#使用内置的验证管道" class="header-anchor">#</a> 使用内置的验证管道</h2> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><code>ValidationPipe</code> 是从 <code>@nestjs/common</code> 包导入的。</p></div> <p>由于此管道使用 <code>class-validator</code> 和 <code>class-transformer</code> 库，因此有许多可用选项。您可以通过传递给管道的配置对象来配置这些设置。以下是内置选项：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ValidationPipeOptions</span> <span class="token keyword">extends</span> <span class="token class-name">ValidatorOptions</span> <span class="token punctuation">{</span>
  transform<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  disableErrorMessages<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  exceptionFactory<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">errors<span class="token operator">:</span> ValidationError<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>除了这些以外，还提供所有类验证器选项(从 <code>ValidatorOptions</code> 接口继承)：</p> <table><thead><tr><th style="text-align:center;">选项</th> <th style="text-align:center;">类型</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>skipMissingProperties</code></td> <td style="text-align:center;"><code>boolean</code></td> <td style="text-align:center;">如果设置为 <code>true</code>，则验证器将跳过对验证对象中缺少的所有属性的验证。</td></tr> <tr><td style="text-align:center;"><code>whitelist</code></td> <td style="text-align:center;"><code>boolean</code></td> <td style="text-align:center;">如果设置为 <code>true</code>，<code>validator</code> 将剥离不使用任何验证装饰器的任何属性的已验证(返回)的对象。</td></tr> <tr><td style="text-align:center;"><code>forbidNonWhitelisted</code></td> <td style="text-align:center;"><code>boolean</code></td> <td style="text-align:center;">如果设置为 <code>true</code>，则验证器会剥离异常，而不是剥离非列入白名单的属性。</td></tr> <tr><td style="text-align:center;"><code>forbidUnknownValues</code></td> <td style="text-align:center;"><code>boolean</code></td> <td style="text-align:center;">如果设置为 <code>true</code>，则尝试验证未知对象的尝试将立即失败。</td></tr> <tr><td style="text-align:center;"><code>disableErrorMessages</code></td> <td style="text-align:center;"><code>boolean</code></td> <td style="text-align:center;">如果设置为 <code>true</code>，验证错误将不会返回给客户端。</td></tr> <tr><td style="text-align:center;"><code>errorHttpStatusCode</code></td> <td style="text-align:center;"><code>number</code></td> <td style="text-align:center;">此设置使您可以指定发生错误时将使用的异常类型。默认情况下，它引发 <code>BadRequestException</code>。</td></tr> <tr><td style="text-align:center;"><code>exceptionFactory</code></td> <td style="text-align:center;"><code>Function</code></td> <td style="text-align:center;">接受验证错误数组，并返回要抛出的异常对象。</td></tr> <tr><td style="text-align:center;"><code>groups</code></td> <td style="text-align:center;"><code>string[]</code></td> <td style="text-align:center;">对象验证期间要使用的组。</td></tr> <tr><td style="text-align:center;"><code>dismissDefaultMessages</code></td> <td style="text-align:center;"><code>boolean</code></td> <td style="text-align:center;">如果设置为 <code>true</code>，则验证将不使用默认消息。如果未明确设置错误消息，则始终是未定义的。</td></tr> <tr><td style="text-align:center;"><code>validationError.target</code></td> <td style="text-align:center;"><code>boolean</code></td> <td style="text-align:center;">指示是否应在 <code>ValidationError</code> 中公开目标</td></tr> <tr><td style="text-align:center;"><code>validationError.value</code></td> <td style="text-align:center;"><code>boolean</code></td> <td style="text-align:center;">指示是否应在 <code>ValidationError</code> 中公开经过验证的值。</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>在其<a href="https://github.com/typestack/class-validator" target="_blank" rel="noopener noreferrer">存储库<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中找到有关 <code>class-validator</code> 包的更多信息。</p></div> <h2 id="自动验证"><a href="#自动验证" class="header-anchor">#</a> 自动验证</h2> <p>我们将从在应用程序级别绑定 <code>ValidationPipe</code> 开始，从而保护所有端点免于接收不正确的数据。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ApplicationModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>为了测试我们的管道，让我们创建一个基本端点。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> createUserDto<span class="token operator">:</span> CreateUserDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'This action adds a new user'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>由于 <code>TypeScript</code> 不会存储有关泛型或接口的元数据，因此当您在 <code>DTO</code> 中使用它们时，<code>ValidationPipe</code> 可能无法正确地验证传入的数据。因此，请考虑在 <code>DTO</code> 中使用具体的类。</p></div> <p>现在，我们可以在 <code>CreateUserDto</code> 中添加一些验证规则。我们使用 <code>class-validator</code> 包提供的装饰器来完成此操作，<a href="https://github.com/typestack/class-validator#validation-decorators" target="_blank" rel="noopener noreferrer"><font colro="red">此处</font><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>有详细说明。以这种方式，任何使用 <code>CreateUserDto</code> 的路由都会自动执行这些验证规则。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> IsEmail<span class="token punctuation">,</span> IsNotEmpty <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CreateUserDto</span> <span class="token punctuation">{</span>
  @<span class="token function">IsEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  @<span class="token function">IsNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有了这些规则，如果请求在请求正文中使用无效的电子邮件属性到达我们的端点，则应用程序将自动以 <code>400 Bad Request</code> 代码以及以下响应正文进行响应：</p> <div class="language-JOSN extra-class"><pre class="language-text"><code>{
  &quot;statusCode&quot;: 400,
  &quot;error&quot;: &quot;Bad Request&quot;,
  &quot;message&quot;: [&quot;email must be an email&quot;]
}
</code></pre></div><p>除了验证请求主体之外，<code>ValidationPipe</code> 也可以与其他请求对象属性一起使用。想象一下，我们想在端点路径中接受 <code>:id</code>。为了确保此请求参数仅接受数字，我们可以使用以下构造：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token function">findOne</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token punctuation">)</span> params<span class="token operator">:</span> FindOneParams</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'This action returns a user'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>像 <code>DTO</code> 一样，<code>FindOneParams</code> 只是一个使用 <code>class-validator</code> 定义验证规则的类。它看起来像这样：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> IsNumberString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">FindOneParams</span> <span class="token punctuation">{</span>
  @<span class="token function">IsNumberString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="禁用错误详情"><a href="#禁用错误详情" class="header-anchor">#</a> 禁用错误详情</h2> <p>错误消息有助于解释请求中的错误。但是，某些生产环境更喜欢禁用错误详情。通过将选项对象传递给 <code>ValidationPipe</code> 来执行此操作：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    disableErrorMessages<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>结果，详细的错误消息将不会显示在响应正文中。</p> <h2 id="属性剥离"><a href="#属性剥离" class="header-anchor">#</a> 属性剥离</h2> <p>我们的 <code>ValidationPipe</code> 还可以过滤掉方法处理程序不应该接收的属性。在这种情况下，我们可以将可接受的属性列入白名单，并且白名单中未包括的任何属性都会自动从结果对象中删除。例如，如果我们的处理程序需要电子邮件和密码属性，但请求还包含 <code>age</code> 属性，则可以从生成的 <code>DTO</code> 中自动删除此属性。要启用这种行为，请将白名单设置为 <code>true</code>。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    whitelist<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>设置为 <code>true</code> 时，这将自动删除未列入白名单的属性(那些在验证类中没有任何装饰器的属性)。</p> <p>或者，您可以在存在非列入白名单的属性时停止处理请求，并将错误响应返回给用户。要启用此功能，请将 <code>forbidNonWhitelisted</code> 选项属性设置为 <code>true</code>，同时将白名单设置为 <code>true</code>。</p> <h2 id="转换加载对象"><a href="#转换加载对象" class="header-anchor">#</a> 转换加载对象</h2> <p>通过网络传入的有效负载是普通的 <code>JavaScript</code> 对象。<code>ValidationPipe</code> 可以将有效载荷自动转换为根据其 <code>DTO</code> 类输入的对象。要启用自动转换，请将 <code>transform</code> 设置为 <code>true</code>。</p> <div class="custom-block tip"><p class="custom-block-title">官方示例</p> <div class="language- extra-class"><pre><code>cats.controller.ts
</code></pre></div></div> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">UsePipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> transform<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> createCatDto<span class="token operator">:</span> CreateCatDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>catsService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>若要全局启用此行为，请在全局管道上设置选项：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>app<span class="token punctuation">.</span><span class="token function">useGlobalPipes</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">ValidationPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    transform<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>启用自动转换选项后，<code>ValidationPipe</code> 还将执行原始类型的转换。在下面的示例中，<code>findOne()</code> 方法采用一个参数，该参数表示提取的 <code>id</code> 路径参数：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token function">findOne</span><span class="token punctuation">(</span>@<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
  <span class="token keyword">return</span> <span class="token string">'This action returns a user'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>默认情况下，每个路径参数和查询参数都以字符串形式通过网络。在上面的示例中，我们将 <code>id</code> 类型指定为数字(在方法签名中)。因此，<code>ValidationPipe</code> 将尝试自动将字符串标识符转换为数字。</p> <h2 id="显式转换"><a href="#显式转换" class="header-anchor">#</a> 显式转换</h2> <p>在上一节中，我们展示了 <code>ValidationPipe</code> 如何根据预期的类型隐式转换查询和路径参数。但是，此功能需要启用自动转换。</p> <p>或者(禁用自动转换)，您可以使用 <code>ParseIntPipe</code> 或 <code>ParseBoolPipe</code> 显式地转换值(请注意，不需要 <code>ParseStringPipe</code>，因为如前所述，默认情况下，每个路径参数和查询参数都以字符串形式通过网络出现)。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token function">findOne</span><span class="token punctuation">(</span>
  @<span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> ParseIntPipe<span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  @<span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">'sort'</span><span class="token punctuation">,</span> ParseBoolPipe<span class="token punctuation">)</span> sort<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> sort <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
  <span class="token keyword">return</span> <span class="token string">'This action returns a user'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>从 <code>@nestjs/common</code> 包导出 <code>ParseIntPipe</code> 和 <code>ParseBoolPipe</code>。</p></div> <h2 id="解析和验证数组"><a href="#解析和验证数组" class="header-anchor">#</a> 解析和验证数组</h2> <p><code>TypeScript</code> 不存储有关泛型或接口的元数据，因此在 <code>DTO</code> 中使用它们时，<code>ValidationPipe</code> 可能无法正确地验证传入的数据。例如，在以下代码中，不会正确验证 <code>createUserDtos</code>：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">createBulk</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> createUserDtos<span class="token operator">:</span> CreateUserDto<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'This action adds new users'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>若要验证数组，请创建一个专用类，其中包含包装该数组的属性，或者使用 <code>ParseArrayPipe</code>。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">createBulk</span><span class="token punctuation">(</span>
  @<span class="token function">Body</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ParseArrayPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> items<span class="token operator">:</span> CreateUserDto <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  createUserDtos<span class="token operator">:</span> CreateUserDto<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'This action adds new users'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此外，在解析查询参数时，<code>ParseArrayPipe</code> 可能会派上用场。让我们考虑一个 <code>findByIds()</code> 方法，该方法基于作为查询参数传递的标识符返回用户。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">findByIds</span><span class="token punctuation">(</span>
  @<span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParseArrayPipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> items<span class="token operator">:</span> Number<span class="token punctuation">,</span> separator<span class="token operator">:</span> <span class="token string">','</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  ids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'This action returns users by ids'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此构造可验证来自 <code>HTTP GET</code> 请求的传入查询参数，如下所示：
GET /?ids=1,2,3</p> <h2 id="websocket-和微服务"><a href="#websocket-和微服务" class="header-anchor">#</a> <code>WebSocket</code> 和微服务</h2> <p>尽管本章显示了使用 <code>HTTP</code> 样式的应用程序(例如 <code>Express</code> 或 <code>Fastify</code>)的示例，但 <code>ValidationPipe</code> 对于 <code>WebSocket</code> 和微服务的工作原理相同，而与使用的传输方法无关。</p> <h2 id="学习更多"><a href="#学习更多" class="header-anchor">#</a> 学习更多</h2> <p>在<a href="https://github.com/typestack/class-validator" target="_blank" rel="noopener noreferrer"><font color="red">此处</font><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>阅读有关类验证器包提供的有关自定义验证器，错误消息和可用装饰器的更多信息。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/frontend-summary/zh/guide/nestjs/techniques/configuration.html" class="prev">
        配置
      </a></span> <span class="next"><a href="/frontend-summary/zh/guide/nestjs/techniques/caching.html">
        缓存
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/frontend-summary/assets/js/app.e4308c2b.js" defer></script><script src="/frontend-summary/assets/js/3.332dd64b.js" defer></script><script src="/frontend-summary/assets/js/49.9c730a4d.js" defer></script>
  </body>
</html>
